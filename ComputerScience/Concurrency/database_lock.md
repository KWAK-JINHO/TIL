# Database Lock

### Database Lock 이란?

데이터베이스가 동시에 실행되는 여러 트랜잭션 간의 데이터 일관성과 격리성을 보장하기 위해 사용하는 동기화 메커니즘.

트랜잭션이 데이터를 읽거나 쓸 때 해당 데이터(row, page, table)에 대한 접근 권한을 제어하여, 동시성 문제를 방지한다.
디스크에 영구 저장된 데이터에 대한 트랜잭션간 동기화로 시스템 장애시에도 복구가 가능하다.

### 주요 특징

- ACID의 격리성 구현의 핵심 메커니즘
- 락의 단위: Row < Page < Table < Database
    - 작을수록 동시성이 좋고 오버헤드가 크다.
- DBMS마다 구현 방식 상이.

---

# Database Lock 전략

## 비관적 락 (Pessimistic Lock)

데이터를 읽는 시점에 미리 락을 걸어 다른 트랜잭션의 접근을 차단하는 방식.
데이터 충돌이 발생할 것을 가정하고 미리 잠금을 설정한다. 데이터 일관성이 중요하고 성능보다 정확성이 중요할 경우 사용한다.

### 구현

- `SELECT ... FOR UPDATE` 쿼리를 사용해 조회 시점에 행(Row)에 락을 건다
- JPA에서는 @Lock 어노테이션으로 편리하게 적용가능.
- 트랜잭션이 완료(커밋/롤백)될 때까지 다른 트랜잭션은 해당 데이터를 수정할 수 없다
- 락이 걸린 데이터를 다른 트랜잭션이 조회하려 하면 대기(Blocking)한다

---

## 낙관적 락 (Optimistic Lock)

데이터를 읽을 때는 락을 걸지 않고, 수정 시점에 버전을 비교해 충돌 여부를 검증하는 방식. 데이터 충돌이 드물 것을 가정한다.

### 구현

- 엔티티에 `version` 컬럼(정수형)을 추가한다
- 데이터 조회 시 현재 버전을 함께 가져온다
- 수정 시 `WHERE version = 조회한_버전` 조건으로 업데이트를 시도한다
- 버전이 다르면 업데이트 실패 → OptimisticLockException 발생
